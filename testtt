-- ğŸ›  Khai bÃ¡o dá»‹ch vá»¥
local UserInputService = game:GetService("UserInputService")
local TweenService = game:GetService("TweenService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Players = game:GetService("Players")
local Workspace = game:GetService("Workspace")

local player = Players.LocalPlayer
local character = player.Character or player.CharacterAdded:Wait()
local humanoidRootPart = character:WaitForChild("HumanoidRootPart")
local humanoid = character:FindFirstChildOfClass("Humanoid")

local function onCharacterAdded(char)
    character = char
    humanoidRootPart = character:WaitForChild("HumanoidRootPart")
    humanoid = character:FindFirstChildOfClass("Humanoid")
end

player.CharacterAdded:Connect(onCharacterAdded)

-- ğŸ–¥ Load Fluent UI
local Library = loadstring(game:HttpGet("https://github.com/dawid-scripts/Fluent/releases/latest/download/main.lua"))()
local SaveData = loadstring(game:HttpGet("https://raw.githubusercontent.com/dawid-scripts/Fluent/master/Addons/SaveManager.lua"))()

if not Library then
    warn("Fluent UI khÃ´ng táº£i Ä‘Æ°á»£c!")
    return
end

local Window = Library:CreateWindow({
    Title = "Knight Hub",
    SubTitle = "By HungK",
    TabWidth = 160,
    Size = UDim2.fromOffset(480, 370),
    Acrylic = true,
    Theme = "Dark"
})

local Tabs = {
    Main = Window:AddTab({ Title = "Main Farm" })
}

-- ğŸ›ï¸ ThÃªm Toggle Farm Level
local Toggle = Tabs.Main:AddToggle("MyToggle", { Title = "Farm Level", Default = false })
_G.FarmLevel = false  

-- ğŸ“Œ Biáº¿n lÆ°u nhiá»‡m vá»¥ cuá»‘i cÃ¹ng Ä‘Ã£ nháº­n
local LastQuest = nil  

-- ğŸ“Œ Kiá»ƒm tra nhÃ¢n váº­t cÃ³ nhiá»‡m vá»¥ khÃ´ng
function HasActiveQuest()
    local questFrame = player.PlayerGui:FindFirstChild("Main") and player.PlayerGui.Main:FindFirstChild("Quest")
    return questFrame and questFrame.Visible
end

-- ğŸƒâ€â™‚ï¸ Tween Ä‘áº¿n vá»‹ trÃ­ mÆ°á»£t hÆ¡n
function TweenToPosition(targetPosition)
    if not humanoidRootPart or not humanoid or not _G.FarmLevel then return end

    local distance = (targetPosition - humanoidRootPart.Position).Magnitude
    if distance < 5 then return end  -- TrÃ¡nh tween khi Ä‘Ã£ gáº§n vá»‹ trÃ­

    local tweenInfo = TweenInfo.new(distance / 185, Enum.EasingStyle.Linear, Enum.EasingDirection.Out)
    local tween = TweenService:Create(humanoidRootPart, tweenInfo, { CFrame = CFrame.new(targetPosition) })

    tween:Play()
    tween.Completed:Wait()
end

-- ğŸ” QuÃ©t quÃ¡i trong pháº¡m vi 125
function FindMobs()
    local mobs = {}
    for _, v in pairs(Workspace:GetChildren()) do
        if v:IsA("Model") and v:FindFirstChild("HumanoidRootPart") and v:FindFirstChild("Humanoid") then
            if v.Name == Ms and (v.HumanoidRootPart.Position - humanoidRootPart.Position).Magnitude <= 125 then
                table.insert(mobs, v)
            end
        end
    end
    return mobs
end

-- ğŸŒ€ Gom quÃ¡i vÃ o vá»‹ trÃ­ X, Z cá»§a CFT, giá»¯ nguyÃªn Y
function GatherMobs(targetCFrame)
    local mobs = FindMobs()
    if #mobs == 0 then return end

    for _, mob in pairs(mobs) do
        if mob:FindFirstChild("HumanoidRootPart") then
            local targetPos = Vector3.new(targetCFrame.Position.X, mob.HumanoidRootPart.Position.Y, targetCFrame.Position.Z)
            local tweenInfo = TweenInfo.new(1, Enum.EasingStyle.Linear, Enum.EasingDirection.Out)
            local tween = TweenService:Create(mob.HumanoidRootPart, tweenInfo, { Position = targetPos })
            tween:Play()
        end
    end
end

-- â³ Chá» quÃ¡i cháº¿t háº¿t trÆ°á»›c khi di chuyá»ƒn tiáº¿p
function WaitForMobsToDie()
    while _G.FarmLevel do
        local mobs = FindMobs()
        if #mobs == 0 then break end
        task.wait(1)
    end
end

-- ğŸ† Nháº­n nhiá»‡m vá»¥ vÃ  di chuyá»ƒn Ä‘áº¿n tá»«ng Ä‘iá»ƒm trong CFT
function GetQuest()
    if not player.Data or not player.Data:FindFirstChild("Level") then return end

    local level = player.Data.Level.Value  
    local NameQuest, LevelQ, CFQ

    -- ğŸ“Œ XÃ¡c Ä‘á»‹nh nhiá»‡m vá»¥ theo cáº¥p Ä‘á»™
    if level >= 1 and level <= 9 then
        NameQuest = "BanditQuest1"
        LevelQ = 1
        CFT = {CFrame.new(943, 40, 1562), CFrame.new(1115, 40, 1619), CFrame.new(1265.79199, 40, 1592.849)}
        CFQ = CFrame.new(1050, 16, 1540)  
        Ms = "Bandit"
    elseif level >= 10 and level <= 14 then
        NameQuest = "JungleQuest"
        LevelQ = 1
        CFT = {CFrame.new(-1673.04834, 30, -73.7299271), CFrame.new(-1570.29041, 30, 339.327484)}
        CFQ = CFrame.new(-1600, 36, 150)  
        Ms = "Monkey"
    elseif level >= 15 and level <= 29 then
        NameQuest = "JungleQuest"
        LevelQ = 2
        CFT = {CFrame.new(-1281.31323, 20, -509.142456), CFrame.new(-1216.53259, 20, -586.503235)}
        CFQ = CFrame.new(-1600, 36, 150)  
        Ms = "Gorilla"
    else
        return
    end

    -- ğŸ“Œ Náº¿u NameQuest thay Ä‘á»•i hoáº·c khÃ´ng cÃ³ nhiá»‡m vá»¥, di chuyá»ƒn Ä‘áº¿n NPC
    if not HasActiveQuest() or LastQuest ~= NameQuest then
        LastQuest = NameQuest
        TweenToPosition(CFQ.Position)
    end

    -- ğŸ Nháº­n nhiá»‡m vá»¥ náº¿u chÆ°a cÃ³
    if (humanoidRootPart.Position - CFQ.Position).Magnitude > 5 then return end

    local success = pcall(function()
        ReplicatedStorage.Remotes.CommF_:InvokeServer("StartQuest", NameQuest, LevelQ)
    end)

    if success then
        LastQuest = NameQuest
    end

    -- ğŸ”„ Di chuyá»ƒn Ä‘áº¿n tá»«ng Ä‘iá»ƒm trong CFT vÃ  gom quÃ¡i
    for _, cft in ipairs(CFT) do
        if not _G.FarmLevel then break end

        TweenToPosition(cft.Position)
        task.wait(math.random(1, 2))  -- Dá»«ng láº¡i 1-2 giÃ¢y

        GatherMobs(cft)  -- Gom quÃ¡i vá» Ä‘iá»ƒm nÃ y
        WaitForMobsToDie()  -- Chá» quÃ¡i cháº¿t trÆ°á»›c khi Ä‘i tiáº¿p
    end
end

-- ğŸ›ï¸ KÃ­ch hoáº¡t Farm Level
Toggle:OnChanged(function()
    _G.FarmLevel = Toggle.Value  
    if _G.FarmLevel then
        while _G.FarmLevel do
            GetQuest()
            task.wait(0.1)  
        end
    end
end)
