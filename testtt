-- ğŸ›  Khai bÃ¡o dá»‹ch vá»¥
local UserInputService = game:GetService("UserInputService")
local TweenService = game:GetService("TweenService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Players = game:GetService("Players")
local RunService = game:GetService("RunService") -- ğŸ†• GiÃºp lÃ m mÆ°á»£t Auto Quest
local Workspace = game:GetService("Workspace")

local player = Players.LocalPlayer
local character = player.Character or player.CharacterAdded:Wait()
local humanoidRootPart = character:WaitForChild("HumanoidRootPart")
local humanoid = character:FindFirstChildOfClass("Humanoid")

local function onCharacterAdded(char)
    character = char
    humanoidRootPart = character:WaitForChild("HumanoidRootPart")
    humanoid = character:FindFirstChildOfClass("Humanoid")
end

player.CharacterAdded:Connect(onCharacterAdded)

-- ğŸ–¥ Load Fluent UI
local Library = loadstring(game:HttpGet("https://github.com/dawid-scripts/Fluent/releases/latest/download/main.lua"))()
local SaveData = loadstring(game:HttpGet("https://raw.githubusercontent.com/dawid-scripts/Fluent/master/Addons/SaveManager.lua"))()

if not Library then
    warn("Fluent UI khÃ´ng táº£i Ä‘Æ°á»£c!")
    return
end

local Window = Library:CreateWindow({
    Title = "Knight Hub",
    SubTitle = "By HungK",
    TabWidth = 160,
    Size = UDim2.fromOffset(480, 370),
    Acrylic = true,
    Theme = "Dark"
})

local Tabs = {
    Main = Window:AddTab({ Title = "Main Farm" })
}

-- ğŸ›ï¸ ThÃªm Toggle Auto Quest
local Toggle = Tabs.Main:AddToggle("MyToggle", { Title = "Auto Quest", Default = false })
_G.AutoQuest = false  

-- ğŸ“Œ Biáº¿n lÆ°u nhiá»‡m vá»¥ cuá»‘i cÃ¹ng Ä‘Ã£ nháº­n
local LastQuest = nil  
local IsTweening = false -- ğŸ†• TrÃ¡nh gá»i Tween liÃªn tá»¥c khi Ä‘ang di chuyá»ƒn
local AutoQuestConnection -- ğŸ†• Biáº¿n lÆ°u káº¿t ná»‘i Auto Quest Ä‘á»ƒ trÃ¡nh giáº­t nháº¹

-- ğŸ“Œ Kiá»ƒm tra nhÃ¢n váº­t cÃ³ nhiá»‡m vá»¥ khÃ´ng
function HasActiveQuest()
    local questFrame = player.PlayerGui:FindFirstChild("Main") and player.PlayerGui.Main:FindFirstChild("Quest")
    return questFrame and questFrame.Visible
end

-- ğŸƒâ€â™‚ï¸ Tween Ä‘áº¿n vá»‹ trÃ­ mÆ°á»£t hÆ¡n vá»›i BodyVelocity (chá»‰ khi báº­t Auto Quest)
function TweenToPosition(targetPosition)
    if not humanoidRootPart or not humanoid or not _G.AutoQuest or IsTweening then return end
    IsTweening = true -- ÄÃ¡nh dáº¥u Ä‘ang tween

    local distance = (targetPosition - humanoidRootPart.Position).Magnitude
    if distance < 5 then
        IsTweening = false
        return
    end  -- TrÃ¡nh tween khi Ä‘Ã£ gáº§n vá»‹ trÃ­

    -- Táº¡o BodyVelocity náº¿u Auto Quest Ä‘ang báº­t
    local bodyVelocity
    if _G.AutoQuest then
        bodyVelocity = Instance.new("BodyVelocity")
        bodyVelocity.Velocity = Vector3.new(0, 0, 0)  -- Giá»¯ nhÃ¢n váº­t á»•n Ä‘á»‹nh
        bodyVelocity.MaxForce = Vector3.new(1e6, 1e6, 1e6)
        bodyVelocity.Parent = humanoidRootPart
    end

    -- Thiáº¿t láº­p TweenService (Speed = 185, KhÃ´ng Giá»›i Háº¡n Thá»i Gian)
    local tweenTime = distance / 185  -- Tá»‘c Ä‘á»™ di chuyá»ƒn 185
    local tweenInfo = TweenInfo.new(tweenTime, Enum.EasingStyle.Linear, Enum.EasingDirection.Out)
    local tween = TweenService:Create(humanoidRootPart, tweenInfo, { CFrame = CFrame.new(targetPosition) })

    tween:Play()
    tween.Completed:Wait()

    -- XÃ³a BodyVelocity sau khi tween xong
    if bodyVelocity then
        bodyVelocity:Destroy()
    end
    IsTweening = false -- Bá» Ä‘Ã¡nh dáº¥u Ä‘ang tween
end

-- ğŸ† Nháº­n nhiá»‡m vá»¥ (Chá»‰ nháº­n láº¡i khi cÃ³ nhiá»‡m vá»¥ má»›i)
function GetQuest()
    if not player.Data or not player.Data:FindFirstChild("Level") then return end

    local level = player.Data.Level.Value  
    local NameQuest, LevelQ, CFQ

    -- ğŸ“Œ XÃ¡c Ä‘á»‹nh nhiá»‡m vá»¥ theo cáº¥p Ä‘á»™
    if level >= 1 and level <= 9 then
        NameQuest = "BanditQuest1"
        LevelQ = 1
        CFQ = CFrame.new(1050, 16, 1540)  
    elseif level >= 10 and level <= 14 then
        NameQuest = "JungleQuest"
        LevelQ = 1
        CFQ = CFrame.new(-1600, 36, 150)  
    elseif level >= 15 and level <= 29 then
        NameQuest = "JungleQuest"
        LevelQ = 2
        CFQ = CFrame.new(-1600, 36, 150)  
    elseif level >= 30 and level <= 39 then
        NameQuest = "BuggyQuest1"
        LevelQ = 1
        CFQ = CFrame.new(-1130, 4, 3820)  
    elseif level >= 40 and level <= 59 then
        NameQuest = "BuggyQuest1"
        LevelQ = 2
        CFQ = CFrame.new(-1140.176, 4.752, 3827.405)  
    else
        return
    end

    -- ğŸ“Œ Náº¿u nhiá»‡m vá»¥ thay Ä‘á»•i hoáº·c chÆ°a cÃ³ nhiá»‡m vá»¥, di chuyá»ƒn Ä‘áº¿n NPC
    if LastQuest ~= NameQuest then
        LastQuest = NameQuest  -- Cáº­p nháº­t nhiá»‡m vá»¥ má»›i
        TweenToPosition(CFQ.Position)  -- Di chuyá»ƒn Ä‘áº¿n NPC
    end

    -- ğŸ Kiá»ƒm tra náº¿u Ä‘Ã£ Ä‘áº¿n vá»‹ trÃ­ NPC trÆ°á»›c khi nháº­n nhiá»‡m vá»¥
    if (humanoidRootPart.Position - CFQ.Position).Magnitude > 5 then return end

    -- ğŸ”„ Nháº­n nhiá»‡m vá»¥
    local success = pcall(function()
        ReplicatedStorage.Remotes.CommF_:InvokeServer("StartQuest", NameQuest, LevelQ)
    end)

    -- Náº¿u nháº­n thÃ nh cÃ´ng, cáº­p nháº­t LastQuest
    if success then
        LastQuest = NameQuest
    end
end

-- ğŸ›ï¸ KÃ­ch hoáº¡t Auto Quest KHÃ”NG GIáº¬T NHáº¸
Toggle:OnChanged(function()
    _G.AutoQuest = Toggle.Value  

    -- Há»§y káº¿t ná»‘i cÅ© náº¿u cÃ³
    if AutoQuestConnection then
        AutoQuestConnection:Disconnect()
    end

    -- Náº¿u báº­t Auto Quest, cháº¡y vÃ²ng láº·p mÆ°á»£t hÆ¡n
    if _G.AutoQuest then
        AutoQuestConnection = RunService.Heartbeat:Connect(function()
            if not IsTweening then -- ğŸ†• Kiá»ƒm tra náº¿u Ä‘ang tween thÃ¬ khÃ´ng kiá»ƒm tra nhiá»‡m vá»¥
                GetQuest()
            end
        end)
    end
end)
