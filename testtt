-- 🛠 Khai báo dịch vụ
local Players = game:GetService("Players")
local Workspace = game:GetService("Workspace")
local TweenService = game:GetService("TweenService")

-- 🏃‍♂️ Khai báo nhân vật người chơi
local player = Players.LocalPlayer
local character = player.Character or player.CharacterAdded:Wait()
local humanoidRootPart = character:WaitForChild("HumanoidRootPart")

-- 🔄 Hàm cập nhật khi nhân vật respawn
local function onCharacterAdded(char)
    character = char
    humanoidRootPart = character:WaitForChild("HumanoidRootPart")
end
player.CharacterAdded:Connect(onCharacterAdded)

-- 🎲 Hàm tạo một điểm gom quái ngẫu nhiên trong phạm vi 125
local function getRandomGatherPosition()
    local randomOffsetX = math.random(-125, 125)
    local randomOffsetZ = math.random(-125, 125)
    local heightOffset = 10  -- Độ cao của nhân vật để tránh bị tấn công
    return humanoidRootPart.Position + Vector3.new(randomOffsetX, 0, randomOffsetZ), heightOffset
end

-- 🔍 Hàm lấy danh sách tất cả quái trong phạm vi
local function getNearbyEnemies(range)
    local enemies = {}

    if not humanoidRootPart then return enemies end

    for _, enemy in pairs(Workspace.Enemies:GetChildren()) do
        if enemy:IsA("Model") and enemy:FindFirstChild("HumanoidRootPart") and enemy:FindFirstChildOfClass("Humanoid") then
            local enemyRoot = enemy:FindFirstChild("HumanoidRootPart")
            local enemyHumanoid = enemy:FindFirstChildOfClass("Humanoid")

            -- Kiểm tra quái còn sống không
            if enemyHumanoid.Health > 0 then
                local distance = (enemyRoot.Position - humanoidRootPart.Position).Magnitude

                -- Chỉ thêm quái nếu trong phạm vi
                if distance <= range then
                    table.insert(enemies, enemy)
                end
            end
        end
    end

    return enemies
end

-- 🚀 Hàm dùng Tween để di chuyển quái đến điểm golocal TweenService = game:GetService("TweenService")
local player = game.Players.LocalPlayer
local character = player.Character or player.CharacterAdded:Wait()
local humanoidRootPart = character:WaitForChild("HumanoidRootPart")

-- 🔥 Giữ nhân vật trên không bằng BodyVelocity
local function ApplyFlight()
    local bodyVelocity = Instance.new("BodyVelocity")
    bodyVelocity.MaxForce = Vector3.new(math.huge, math.huge, math.huge)
    bodyVelocity.Velocity = Vector3.new(0, 0, 0)
    bodyVelocity.Parent = humanoidRootPart

    -- 🔁 Duy trì trên không
    task.spawn(function()
        while task.wait() do
            bodyVelocity.Velocity = Vector3.new(0, 0, 0)
        end
    end)
end

ApplyFlight()

-- 🌀 Gom quái liên tục tween về đúng vị trí
local function GatherMobs(targetPosition)
    local gathered = 0
    for _, mob in pairs(game.Workspace.Enemies:GetChildren()) do
        if gathered >= 3 then break end -- 🔥 Giới hạn 3 quái
        if mob.Name == TargetMob and mob:FindFirstChild("HumanoidRootPart") then
            local targetCFrame = CFrame.new(targetPosition.X, mob.HumanoidRootPart.Position.Y, targetPosition.Z)

            -- 🔥 Liên tục tween quái về đúng vị trí
            task.spawn(function()
                while mob.Parent and mob:FindFirstChild("HumanoidRootPart") do
                    local tween = TweenService:Create(
                        mob.HumanoidRootPart,
                        TweenInfo.new(0.2, Enum.EasingStyle.Linear, Enum.EasingDirection.Out),
                        {CFrame = targetCFrame}
                    )
                    tween:Play()
                    task.wait(0.2)
                end
            end)

            gathered = gathered + 1
        end
    end
end

-- 🔥 Kiểm tra nếu tất cả quái đã chết
local function AllMobsDead()
    for _, mob in pairs(game.Workspace.Enemies:GetChildren()) do
        if mob.Name == TargetMob then
            return false
        end
    end
    return true
end

-- 📍 Di chuyển qua từng điểm trong CFT
local function MoveThroughPoints()
    for _, targetCFrame in ipairs(TargetCFT) do
        TweenToPosition(targetCFrame, 120) -- 🔥 Tween với tốc độ 50
        task.wait(1)
        GatherMobs(targetCFrame.Position)

        while not AllMobsDead() do
            task.wait(0.5)
        end
    end
end

-- 🎯 Bắt đầu farm
local function StartFarming()
    local level = player.Data.Level.Value
    local NameQuest, LevelQ, CFT, CFQ, Ms = GetQuestInfo(level)

    TargetQuest = NameQuest
    TargetQuestLevel = LevelQ
    TargetCFT = CFT
    TargetCFQ = CFQ
    TargetMob = Ms

    MoveThroughPoints()
end

StartFarming()
