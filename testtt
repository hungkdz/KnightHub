local TweenService = game:GetService("TweenService")
local player = game.Players.LocalPlayer
local ReplicatedStorage = game:GetService("ReplicatedStorage")

local function GetCharacter()
    local character = player.Character or player.CharacterAdded:Wait()
    return character
end

local function ApplyFlight(character)
    local humanoidRootPart = character:FindFirstChild("HumanoidRootPart")
    if humanoidRootPart then
        local bodyGyro = Instance.new("BodyGyro")
        bodyGyro.MaxTorque = Vector3.new(math.huge, math.huge, math.huge)
        bodyGyro.CFrame = humanoidRootPart.CFrame
        bodyGyro.Parent = humanoidRootPart

        local bodyVelocity = Instance.new("BodyVelocity")
        bodyVelocity.MaxForce = Vector3.new(math.huge, math.huge, math.huge)
        bodyVelocity.Velocity = Vector3.new(0, 0, 0)
        bodyVelocity.Parent = humanoidRootPart

        -- ğŸ”„ Duy trÃ¬ trÃªn khÃ´ng
        task.spawn(function()
            while character and character.Parent do
                bodyVelocity.Velocity = Vector3.new(0, 0, 0)
                task.wait(0.1)
            end
        end)
    end
end

local function OnCharacterAdded(character)
    ApplyFlight(character)
    local level = player.Data.Level.Value  
    local NameQuest, LevelQ, CFT, CFQ, Ms

    -- ğŸ“Œ XÃ¡c Ä‘á»‹nh nhiá»‡m vá»¥ theo cáº¥p Ä‘á»™
    if level >= 1 and level <= 9 then
        NameQuest = "BanditQuest1"
        LevelQ = 1
        CFT = {CFrame.new(943, 40, 1562), CFrame.new(1115, 40, 1619)}
        CFQ = CFrame.new(1050, 16, 1540)  
        Ms = "Bandit"
    elseif level >= 10 and level <= 14 then
        NameQuest = "JungleQuest"
        LevelQ = 1
        CFT = {CFrame.new(-1673, 30, -73), CFrame.new(-1570, 30, 339)}
        CFQ = CFrame.new(-1600, 36, 150)  
        Ms = "Monkey"
    elseif level >= 15 and level <= 29 then
        NameQuest = "JungleQuest"
        LevelQ = 2
        CFT = {CFrame.new(-1281, 20, -509), CFrame.new(-1216, 20, -586)}
        CFQ = CFrame.new(-1600, 36, 150)  
        Ms = "Gorilla"
    elseif level >= 30 and level <= 39 then
        NameQuest = "BuggyQuest1"
        LevelQ = 1
        CFT = {CFrame.new(-1160, 18, 3929), CFrame.new(-1264, 18, 3903)}
        CFQ = CFrame.new(-1130, 4, 3820)  
        Ms = "Pirate"
    elseif level >= 40 and level <= 59 then
        NameQuest = "BuggyQuest1"
        LevelQ = 2
        CFT = {CFrame.new(-1204, 30, 4286), CFrame.new(-962, 30, 4312)}
        CFQ = CFrame.new(-1140, 4, 3827)  
        Ms = "Brute"
    end

    -- ğŸ”¥ **Tween nhÃ¢n váº­t báº±ng tá»‘c Ä‘á»™**
    local function TweenToPosition(character, targetCFrame, speed)
        local humanoidRootPart = character:FindFirstChild("HumanoidRootPart")
        if humanoidRootPart then
            local distance = (humanoidRootPart.Position - targetCFrame.Position).Magnitude
            local time = distance / speed -- Thá»i gian dá»±a trÃªn tá»‘c Ä‘á»™

            local tween = TweenService:Create(
                humanoidRootPart,
                TweenInfo.new(time, Enum.EasingStyle.Linear, Enum.EasingDirection.Out),
                {CFrame = targetCFrame}
            )
            tween:Play()
            tween.Completed:Wait()
        end
    end

    -- ğŸ”¥ **Gom quÃ¡i vÃ o tá»«ng vá»‹ trÃ­ trong `CFT`**
    local function GatherMobs(targetCFrame)
        local gathered = 0
        for _, mob in pairs(game.Workspace.Enemies:GetChildren()) do
            if gathered >= 3 then break end -- Chá»‰ gom tá»‘i Ä‘a 3 quÃ¡i
            if mob.Name == Ms and mob:FindFirstChild("HumanoidRootPart") then
                local mobPos = mob.HumanoidRootPart.Position
                if (mobPos - targetCFrame.Position).Magnitude <= 125 then -- ğŸ“ Kiá»ƒm tra pháº¡m vi 125
                    if mob.HumanoidRootPart.Anchored then
                        mob.HumanoidRootPart.Anchored = false
                    end

                    -- Giá»¯ quÃ¡i cá»‘ Ä‘á»‹nh
                    local bodyVelocity = Instance.new("BodyVelocity")
                    bodyVelocity.MaxForce = Vector3.new(math.huge, math.huge, math.huge)
                    bodyVelocity.Velocity = Vector3.new(0, 0, 0)
                    bodyVelocity.Parent = mob.HumanoidRootPart

                    -- Tween quÃ¡i Ä‘áº¿n vá»‹ trÃ­
                    local tween = TweenService:Create(
                        mob.HumanoidRootPart,
                        TweenInfo.new(0.3, Enum.EasingStyle.Linear, Enum.EasingDirection.Out),
                        {CFrame = CFrame.new(targetCFrame.X, mob.HumanoidRootPart.Position.Y, targetCFrame.Z)}
                    )
                    tween:Play()
                    tween.Completed:Wait()
                    gathered = gathered + 1
                end
            end
        end
    end

    -- ğŸ”¥ **Kiá»ƒm tra quÃ¡i lá»—i hoáº·c cÃ²n sá»‘ng**
    local function AllMobsDeadOrBugged()
        local deadCount = 0
        local totalMobs = 0
        local hasBuggedMob = false

        for _, mob in pairs(game.Workspace.Enemies:GetChildren()) do
            if mob.Name == Ms then
                local humanoid = mob:FindFirstChildOfClass("Humanoid")
                if humanoid then
                    totalMobs = totalMobs + 1
                    if humanoid.Health <= 0 then
                        deadCount = deadCount + 1
                    else
                        -- ğŸ”„ Kiá»ƒm tra quÃ¡i cÃ³ máº¥t mÃ¡u khÃ´ng
                        local oldHealth = humanoid.Health
                        task.wait(3) -- Chá» 3 giÃ¢y
                        if humanoid.Health == oldHealth then
                            hasBuggedMob = true
                        end
                    end
                end
            end
        end

        -- Náº¿u Ã­t nháº¥t 1 quÃ¡i cháº¿t vÃ  cÃ³ 1 con bá»‹ lá»—i â†’ bá» qua, di chuyá»ƒn tiáº¿p
        if deadCount > 0 and hasBuggedMob then
            return true
        end

        -- Náº¿u táº¥t cáº£ quÃ¡i Ä‘á»u Ä‘Ã£ cháº¿t â†’ di chuyá»ƒn tiáº¿p
        return totalMobs == deadCount
    end

    -- ğŸ”¥ **Di chuyá»ƒn qua tá»«ng Ä‘iá»ƒm `CFT` vÃ  gom quÃ¡i**
    local function MoveThroughPoints(character)
        local speed = 100 -- âš¡ Tá»‘c Ä‘á»™ di chuyá»ƒn

        for _, targetCFrame in ipairs(CFT) do
            TweenToPosition(character, targetCFrame, speed)
            task.wait(1)
            GatherMobs(targetCFrame) -- ğŸ›  Gom quÃ¡i vÃ o Ä‘iá»ƒm hiá»‡n táº¡i
            while not AllMobsDeadOrBugged() do
                task.wait(0.2)
            end
        end
    end

    -- ğŸ›  **Loop Ä‘á»ƒ farm liÃªn tá»¥c**
    task.spawn(function()
        while true do
            MoveThroughPoints(character)
            task.wait(1)
        end
    end)
end

-- ğŸš€ **Khá»Ÿi Ä‘á»™ng script**
player.CharacterAdded:Connect(OnCharacterAdded)
OnCharacterAdded(GetCharacter())
