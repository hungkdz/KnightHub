-- ðŸ§® Khai bÃ¡o dá»‹ch vá»¥
local UserInputService = game:GetService("UserInputService")
local TweenService = game:GetService("TweenService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Players = game:GetService("Players")
local Workspace = game:GetService("Workspace")

local player = Players.LocalPlayer
local character
local humanoidRootPart
local humanoid
local noclip = false
local firstQuestClaimed = false
local isFirstToggle = true

local function onCharacterAdded(char)
    character = char
    humanoidRootPart = character:WaitForChild("HumanoidRootPart")
    humanoid = character:FindFirstChildOfClass("Humanoid")
end

player.CharacterAdded:Connect(onCharacterAdded)
if player.Character then
    onCharacterAdded(player.Character)
end

-- ðŸ”¦ Load Fluent UI
local Library = loadstring(game:HttpGet("https://github.com/dawid-scripts/Fluent/releases/latest/download/main.lua"))()
local SaveData = loadstring(game:HttpGet("https://raw.githubusercontent.com/dawid-scripts/Fluent/master/Addons/SaveManager.lua"))()

if not Library then
    warn("Fluent UI khÃ´ng táº£i Ä‘Æ°á»£c!")
    return
end

local Window = Library:CreateWindow({
    Title = "Knight Hub",
    SubTitle = "By HungK",
    TabWidth = 160,
    Size = UDim2.fromOffset(480, 370),
    Acrylic = true,
    Theme = "Dark"
})

local Tabs = {
    Main = Window:AddTab({ Title = "Main Farm" })
}

-- ðŸŽ›ï¸ ThÃªm Toggle Auto Quest
local Toggle = Tabs.Main:AddToggle("MyToggle", { Title = "Auto Quest", Default = false })
_G.AutoQuest = false  

Toggle:OnChanged(function()
    _G.AutoQuest = Toggle.Value  
    if _G.AutoQuest then
        firstQuestClaimed = false
        if isFirstToggle then
            isFirstToggle = false
            task.wait(3) -- Äá»£i 3 giÃ¢y trÆ°á»›c khi báº¯t Ä‘áº§u
        end
        task.spawn(function()
            if humanoidRootPart then
                GetQuest()
            end
        end)
    end
    while _G.AutoQuest do
        local questFrame = player.PlayerGui:FindFirstChild("Main") and player.PlayerGui.Main:FindFirstChild("Quest")
        if not (questFrame and questFrame.Visible) or CheckQuestMismatch() then
            GetQuest()
        end
        task.wait(5)  
    end
end)

-- ðŸƒâ€â™‚ï¸ Fix rung camera, NoClip vÃ  lá»—i tá»‘c Ä‘á»™ khi di chuyá»ƒn báº±ng Tween
function TweenToPosition(targetPosition)
    if not humanoidRootPart or not humanoid then return end

    task.wait(3) -- Delay 3 giÃ¢y trÆ°á»›c khi tween

    local bodyVelocity = Instance.new("BodyVelocity")
    bodyVelocity.Velocity = Vector3.new(0, 0, 0)
    bodyVelocity.MaxForce = Vector3.new(1e6, 1e6, 1e6)
    bodyVelocity.Parent = humanoidRootPart

    noclip = true -- Báº­t NoClip
    
    local magnitude = (targetPosition - humanoidRootPart.Position).Magnitude
    local tweenTime = magnitude / 300  
    local tweenInfo = TweenInfo.new(tweenTime, Enum.EasingStyle.Linear, Enum.EasingDirection.Out)
    local tween = TweenService:Create(humanoidRootPart, tweenInfo, { CFrame = CFrame.new(targetPosition) })
    
    tween:Play()
    tween.Completed:Wait()
    
    bodyVelocity:Destroy()
    humanoidRootPart.CFrame = CFrame.new(targetPosition)
    noclip = false -- Táº¯t NoClip
    task.wait(0.5)
end

-- ðŸ† Kiá»ƒm tra nhiá»‡m vá»¥ cÃ³ phÃ¹ há»£p vá»›i level hiá»‡n táº¡i khÃ´ng
function CheckQuestMismatch()
    if not player.Data or not player.Data:FindFirstChild("Level") then return false end
    local level = player.Data.Level.Value  
    local questFrame = player.PlayerGui:FindFirstChild("Main") and player.PlayerGui.Main:FindFirstChild("Quest")
    if questFrame and questFrame.Visible then
        local currentQuestName = questFrame.Title.Text -- Giáº£ sá»­ tÃªn nhiá»‡m vá»¥ hiá»ƒn thá»‹ á»Ÿ Ä‘Ã¢y
        local expectedQuestName = GetExpectedQuestName(level)
        return currentQuestName ~= expectedQuestName
    end
    return false
end

-- ðŸ† Nháº­n nhiá»‡m vá»¥
function GetQuest()
    if not player.Data or not player.Data:FindFirstChild("Level") then return end
    local level = player.Data.Level.Value  
    local NameQuest, LevelQ, CFQ

    if level >= 1 and level <= 9 then
        NameQuest = "BanditQuest1"
        LevelQ = 1
        CFQ = CFrame.new(1050, 16, 1540)  
    elseif level >= 10 and level <= 14 then
        NameQuest = "JungleQuest"
        LevelQ = 1
        CFQ = CFrame.new(-1600, 36, 150)  
    elseif level >= 15 and level <= 29 then
        NameQuest = "JungleQuest"
        LevelQ = 2
        CFQ = CFrame.new(-1600, 36, 150)  
    elseif level >= 30 and level <= 39 then
        NameQuest = "BuggyQuest1"
        LevelQ = 1
        CFQ = CFrame.new(-1130, 4, 3820)  
    elseif level >= 40 and level <= 59 then
        NameQuest = "BuggyQuest1"
        LevelQ = 2
        CFQ = CFrame.new(-1140.176, 4.752, 3827.405)  
    else
        return
    end

    -- ðŸ”„ Delay trÆ°á»›c khi di chuyá»ƒn Ä‘áº¿n NPC nháº­n nhiá»‡m vá»¥
    task.wait(3)
    
    if humanoidRootPart then
        TweenToPosition(Vector3.new(CFQ.X, CFQ.Y, CFQ.Z))
    else
        return
    end

    -- ðŸ Kiá»ƒm tra láº¡i náº¿u Ä‘Ã£ Ä‘áº¿n vá»‹ trÃ­ NPC trÆ°á»›c khi nháº­n nhiá»‡m vá»¥
    local distance = (humanoidRootPart.Position - Vector3.new(CFQ.X, CFQ.Y, CFQ.Z)).Magnitude
    if distance > 5 then
        return
    end

    -- ðŸš€ Nháº­n nhiá»‡m vá»¥ náº¿u chÆ°a cÃ³ hoáº·c khÃ´ng Ä‘Ãºng nhiá»‡m vá»¥
    if CheckQuestMismatch() or not firstQuestClaimed then
        pcall(function()
            ReplicatedStorage.Remotes.CommF_:InvokeServer("StartQuest", NameQuest, LevelQ)
        end)
        firstQuestClaimed = true
    end
end
