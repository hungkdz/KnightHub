-- 🛠 Khai báo dịch vụ
local UserInputService = game:GetService("UserInputService")
local TweenService = game:GetService("TweenService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Players = game:GetService("Players")
local Workspace = game:GetService("Workspace")
local Camera = Workspace.CurrentCamera

local player = Players.LocalPlayer
local character = player.Character or player.CharacterAdded:Wait()
local humanoidRootPart = character:WaitForChild("HumanoidRootPart")
local humanoid = character:FindFirstChildOfClass("Humanoid")

-- 🖥 Load Fluent UI
local Library = loadstring(game:HttpGet("https://github.com/dawid-scripts/Fluent/releases/latest/download/main.lua"))()
local SaveData = loadstring(game:HttpGet("https://raw.githubusercontent.com/dawid-scripts/Fluent/master/Addons/SaveManager.lua"))()

if not Library then
    warn("Fluent UI không tải được!")
    return
end

local Window = Library:CreateWindow({
    Title = "Knight Hub",
    SubTitle = "By HungK",
    TabWidth = 160,
    Size = UDim2.fromOffset(480, 370),
    Acrylic = true,
    Theme = "Dark",
    MinimizeKey = Enum.KeyCode.LeftControl -- Used when theres no MinimizeKeybind
})

local Tabs = {
    Main = Window:AddTab({ Title = "Main Farm" })
}

-- 🎛️ Thêm Toggle Auto Quest
local Toggle = Tabs.Main:AddToggle("MyToggle", { Title = "Farm Level", Default = false })
_G.AutoQuest = false  

Toggle:OnChanged(function()
    _G.AutoQuest = Toggle.Value  
    if _G.AutoQuest then
        while _G.AutoQuest do
            GetQuest()
            task.wait(5)  
        end
    end
end)

-- 🏃‍♂️ Fix rung camera khi di chuyển
function TweenToPosition(targetPosition)
    if not humanoidRootPart then return end

    local speed = 175  
    local tweenTime = (humanoidRootPart.Position - targetPosition).Magnitude / speed

    humanoidRootPart:SetNetworkOwner(nil)  -- Tắt quyền điều khiển tạm thời

    local targetCFrame = CFrame.new(
        targetPosition.X, humanoidRootPart.Position.Y, targetPosition.Z,
        humanoidRootPart.CFrame:ToEulerAnglesYXZ()
    )

    local tweenInfo = TweenInfo.new(tweenTime, Enum.EasingStyle.Linear, Enum.EasingDirection.Out)
    local tween = TweenService:Create(humanoidRootPart, tweenInfo, {CFrame = targetCFrame})

    -- Cập nhật camera để theo dõi nhân vật
    Camera.CameraType = Enum.CameraType.Scriptable
    local function updateCamera()
        Camera.CFrame = humanoidRootPart.CFrame * CFrame.new(0, 5, -10)
    end

    local connection = game:GetService("RunService").RenderStepped:Connect(updateCamera)

    tween:Play()
    tween.Completed:Wait()

    connection:Disconnect()
    Camera.CameraType = Enum.CameraType.Custom
    
    humanoidRootPart.CFrame = targetCFrame
    humanoid:MoveTo(targetPosition)

    task.wait(0.1)
    humanoidRootPart:SetNetworkOwner(Players.LocalPlayer)  -- Trả lại quyền điều khiển
end

-- 🏆 Nhận nhiệm vụ
function GetQuest()
    if not player.Data or not player.Data:FindFirstChild("Level") then return end

    local level = player.Data.Level.Value  
    local NameQuest, LevelQ, CFQ

    if level >= 1 and level <= 9 then
        NameQuest = "BanditQuest1"
        LevelQ = 1
        CFQ = CFrame.new(1050, 16, 1540)  
    elseif level >= 10 and level <= 14 then
        NameQuest = "JungleQuest"
        LevelQ = 1
        CFQ = CFrame.new(-1600, 36, 150)  
    elseif level >= 15 and level <= 29 then
        NameQuest = "JungleQuest"
        LevelQ = 2
        CFQ = CFrame.new(-1600, 36, 150)  
    elseif level >= 30 and level <= 39 then
        NameQuest = "BuggyQuest1"
        LevelQ = 1
        CFQ = CFrame.new(-1130, 4, 3820)  
    elseif level >= 40 and level <= 59 then
        NameQuest = "BuggyQuest1"
        LevelQ = 2
        CFQ = CFrame.new(-1140.176, 4.752, 3827.405)  
    else
        return
    end

    -- 🏁 Luôn nhận lại nhiệm vụ trước khi kiểm tra
    pcall(function()
        ReplicatedStorage.Remotes.CommF_:InvokeServer("StartQuest", NameQuest, LevelQ)
    end)

    -- 🛑 Kiểm tra nếu đã có nhiệm vụ
    local questFrame = player.PlayerGui:FindFirstChild("Main") and player.PlayerGui.Main:FindFirstChild("Quest")
    local hasQuest = questFrame and questFrame.Visible

    if not hasQuest then
        -- 🚀 Nếu chưa có nhiệm vụ, di chuyển đến NPC để nhận nhiệm vụ
        TweenToPosition(CFQ.Position)
        task.wait(0.5)  -- Đợi một chút trước khi gửi yêu cầu nhận nhiệm vụ

        pcall(function()
            ReplicatedStorage.Remotes.CommF_:InvokeServer("StartQuest", NameQuest, LevelQ)
        end)
    end
end

-- 🖥️ Thêm GUI
local ic = Instance.new("ScreenGui")
ic.Parent = game.CoreGui
ic.Name = "knight"
ic.ClipToDeviceSafeArea = true
ic.Enabled = true
ic.ResetOnSpawn = true
ic.ZIndexBehavior = Enum.ZIndexBehavior.Sibling
ic.Archivable = true
ic.AutoLocalize = true

local ic2 = Instance.new("Frame")
ic2.Parent = ic
ic2.Name = "dz"
ic2.AnchorPoint = Vector2.new(0, 1)
ic2.BackgroundColor3 = Color3.fromRGB(255, 255, 255)
ic2.BackgroundTransparency = 0.25
ic2.BorderSizePixel = 1
ic2.Position = UDim2.new(0, 15, 0.2, 5)
ic2.Size = UDim2.new(0, 50, 0, 50)

local ic3 = Instance.new("UICorner")
ic3.CornerRadius = UDim.new(1, 0)
ic3.Archivable = true
ic3.Parent = ic2

local ic4 = Instance.new("TextButton")
ic4.Parent = ic2
ic4.Active = true
ic4.AnchorPoint = Vector2.new(0, 0)
ic4.BackgroundTransparency = 1
ic4.Size = UDim2.new(1, 0, 1, 0)
ic4.Text = ""

local ic5 = Instance.new("ImageLabel")
ic5.Parent = ic2
ic5.Size = UDim2.new(0, 30, 0, 30)
ic5.Position = UDim2.new(0.5, 0, 0.5, 0)
ic5.AnchorPoint = Vector2.new(0.5, 0.5)
ic5.BackgroundTransparency = 1
ic5.Image = "rbxassetid://71222902950411"

local isOriginalState = true
ic4.MouseButton1Click:Connect(function()
    Window:SetMinimized(isOriginalState)
    ic2.BackgroundTransparency = isOriginalState and 0 or 0.25
    ic5.Size = isOriginalState and UDim2.new(0, 40, 0, 40) or UDim2.new(0, 30, 0, 30)
    isOriginalState = not isOriginalState
end)
